pipeline {
    
    agent any
    
    stages {
        stage('gitlab clone') {
            steps {
                git branch: 'FE/develop', credentialsId: 'jenkins_token', url: 'http://lab.ssafy.com/s10-fintech-finance-sub2/S10P22D203.git'
            }
        }
        
        stage('Build') {
            steps {
                dir("./finfarm-frontend") {
                    nodejs(nodeJSInstallationName: 'NodeJS 16.14.0') {
                        sh 'CI=false npm install && CI=sudo chmod +x node_modules/.bin/react-scripts'
                        sh 'CI=false npm run build'
                    }
                }
            }
        }
        
        stage('Compression') {
            steps {
                dir("./finfarm-frontend") {
                    sh '''
                    rm -rf node_modules
                    tar -cvf front_0.1.0.tar .
                    '''
                }
            }
        }
        
        stage('Deploy') {
            steps {
                sshagent(credentials: ['ssh_key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ubuntu@j10d203.p.ssafy.io
                        scp /var/jenkins_home/workspace/front/front/front_0.1.0.tar ubuntu@j10d203.p.ssafy.io:/home/ubuntu/Frontend
                        ssh -t ubuntu@j10d203.p.ssafy.io ./deploy_fe.sh
                    '''
                }
                timeout(time: 30, unit: 'SECONDS') {
                }
            }
        }
    }
}